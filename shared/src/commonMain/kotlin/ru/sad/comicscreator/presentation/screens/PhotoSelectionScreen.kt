package ru.sad.comicscreator.presentation.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.ImageBitmap
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import androidx.lifecycle.viewmodel.compose.viewModel
import com.preat.peekaboo.image.picker.SelectionMode
import com.preat.peekaboo.image.picker.rememberImagePickerLauncher
import com.preat.peekaboo.image.picker.toImageBitmap
import com.preat.peekaboo.ui.camera.PeekabooCamera
import com.preat.peekaboo.ui.camera.rememberPeekabooCameraState
import kotlinx.coroutines.launch
import kotlinx.serialization.json.Json
import org.koin.compose.viewmodel.koinViewModel
import ru.sad.comicscreator.domain.model.SelectedPhoto
import ru.sad.comicscreator.platform.PermissionsHelper
import ru.sad.comicscreator.platform.createPermissionsHelper
import ru.sad.comicscreator.presentation.navigation.Screen
import ru.sad.comicscreator.presentation.viewmodel.PhotoSelectionViewModel

@Composable
fun PhotoSelectionScreen(
    onBackPressed: () -> Unit,
    onContinueClick: () -> Unit,
    viewModel: PhotoSelectionViewModel = koinViewModel()
) {
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ ViewModel
    val availablePhotos by viewModel.availablePhotos.collectAsStateWithLifecycle()
    val selectedPhotos by viewModel.selectedPhotos.collectAsStateWithLifecycle()
    val errorMessage by viewModel.errorMessage.collectAsStateWithLifecycle()

    var showCamera by remember { mutableStateOf(false) }
    val scope = rememberCoroutineScope()

    val permissionsHelper = createPermissionsHelper()
    
    // Launcher –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
    val galleryLauncher = rememberImagePickerLauncher(
        selectionMode = SelectionMode.Multiple(maxSelection = 10),
        scope = rememberCoroutineScope(),
        onResult = { byteArrays ->
            byteArrays.forEach { byteArray ->
                viewModel.addPhotoFromByteArray(byteArray, false)
            }
        }
    )
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã
    val cameraState = rememberPeekabooCameraState(
        onCapture = { byteArray ->
            byteArray?.let { 
                viewModel.addPhotoFromByteArray(it, true)
                showCamera = false
            }
        }
    )
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∫–∞–º–µ—Ä—ã –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞–º–µ—Ä–∞
    if (showCamera) {
        CameraScreen(
            cameraState = cameraState,
            onBack = { showCamera = false }
        )
        return
    }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.White)
            .padding(24.dp)
    ) {
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥
        Row(
            modifier = Modifier.fillMaxWidth(),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
            Card(
                modifier = Modifier
                    .size(40.dp)
                    .clickable { onBackPressed() },
                colors = CardDefaults.cardColors(
                    containerColor = Color(0xFFF5F5F5)
                ),
                shape = RoundedCornerShape(12.dp)
            ) {
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    Text(
                        text = "‚Üê",
                        fontSize = 20.sp,
                        color = Color.Black
                    )
                }
            }
            
            Spacer(modifier = Modifier.width(16.dp))
            
            Text(
                text = "–ó–∞–≥—Ä—É–∑–∏—Ç–µ\n—Ñ–æ—Ç–æ",
                style = MaterialTheme.typography.headlineMedium,
                fontWeight = FontWeight.Bold,
                color = Color.Black,
                textAlign = TextAlign.Center,
                modifier = Modifier.weight(1f)
            )
            
            Spacer(modifier = Modifier.width(56.dp)) // –ë–∞–ª–∞–Ω—Å –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
        }
        
        Spacer(modifier = Modifier.height(32.dp))
        
        // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
        Text(
            text = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏",
            style = MaterialTheme.typography.titleLarge,
            fontWeight = FontWeight.SemiBold,
            color = Color.Black
        )
        
        Spacer(modifier = Modifier.height(8.dp))
        
        Text(
            text = "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Å–µ–±—è –∏ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∏—Ö –≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∫–æ–º–∏–∫—Å–∞",
            style = MaterialTheme.typography.bodyMedium,
            color = Color.Gray,
            lineHeight = 20.sp
        )
        
        Spacer(modifier = Modifier.height(32.dp))
        
        // –°–µ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        LazyVerticalGrid(
            columns = GridCells.Fixed(2),
            horizontalArrangement = Arrangement.spacedBy(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp),
            modifier = Modifier.weight(1f)
        ) {
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            items(availablePhotos) { photo ->
                PhotoItem(
                    photo = photo,
                    onRemove = { viewModel.removePhoto(photo.id) },
                    onSelect = { viewModel.togglePhotoSelection(photo.id) }
                )
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
            item {
                AddPhotoItem(
                    onClick = { /* –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ */ }
                )
            }
        }
        
        Spacer(modifier = Modifier.height(24.dp))
        
        // –ö–Ω–æ–ø–∫–∏ –≥–∞–ª–µ—Ä–µ—è –∏ –∫–∞–º–µ—Ä–∞
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // –ö–Ω–æ–ø–∫–∞ –≥–∞–ª–µ—Ä–µ–∏
            Button(
                onClick = { 
                    scope.launch {
                        if (permissionsHelper.requestGalleryPermission()) {
                            galleryLauncher.launch()
                        } else {
                            viewModel.clearError()
                            // TODO: –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
                        }
                    }
                },
                modifier = Modifier
                    .weight(1f)
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = Color(0xFF9C27B0) // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                ),
                shape = RoundedCornerShape(28.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.Center
                ) {
                    Text("üìÅ", fontSize = 18.sp)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "–ì–∞–ª–µ—Ä–µ—è",
                        color = Color.White,
                        fontWeight = FontWeight.Medium
                    )
                }
            }
            
            // –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã
            Button(
                onClick = { 
                    scope.launch {
                        if (permissionsHelper.requestCameraPermission()) {
                            showCamera = true
                        } else {
                            viewModel.clearError()
                            // TODO: –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
                        }
                    }
                },
                modifier = Modifier
                    .weight(1f)
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = Color(0xFF2196F3) // –°–∏–Ω–∏–π
                ),
                shape = RoundedCornerShape(28.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.Center
                ) {
                    Text("üì∑", fontSize = 18.sp)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "–ö–∞–º–µ—Ä–∞",
                        color = Color.White,
                        fontWeight = FontWeight.Medium
                    )
                }
            }
        }
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        Button(
            onClick = onContinueClick,
            modifier = Modifier
                .fillMaxWidth()
                .height(56.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = Color(0xFF2196F3) // –°–∏–Ω–∏–π
            ),
            shape = RoundedCornerShape(28.dp),
            enabled = viewModel.canContinue() // –ê–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–æ—Ç–æ
        ) {
            Text(
                text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                color = Color.White,
                fontWeight = FontWeight.SemiBold,
                fontSize = 16.sp
            )
        }
    }
}

@Composable
fun CameraScreen(
    cameraState: com.preat.peekaboo.ui.camera.PeekabooCameraState,
    onBack: () -> Unit
) {
    Box(modifier = Modifier.fillMaxSize()) {
        PeekabooCamera(
            state = cameraState,
            modifier = Modifier.fillMaxSize(),
            permissionDeniedContent = {
                // UI –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è—Ö
                Column(
                    modifier = Modifier.fillMaxSize(),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Text(
                        text = "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É",
                        style = MaterialTheme.typography.headlineSmall
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                    Text(
                        text = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö",
                        style = MaterialTheme.typography.bodyMedium,
                        textAlign = TextAlign.Center
                    )
                }
            }
        )
        
        // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        Card(
            modifier = Modifier
                .align(Alignment.TopStart)
                .padding(16.dp)
                .size(48.dp)
                .clickable { onBack() },
            colors = CardDefaults.cardColors(
                containerColor = Color.Black.copy(alpha = 0.5f)
            ),
            shape = RoundedCornerShape(24.dp)
        ) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "‚Üê",
                    color = Color.White,
                    fontSize = 20.sp
                )
            }
        }
    }
}

@Composable
fun PhotoItem(
    photo: SelectedPhoto,
    onRemove: () -> Unit,
    onSelect: () -> Unit
) {
    Box(
        modifier = Modifier
            .aspectRatio(1f)
            .clip(RoundedCornerShape(16.dp))
            .clickable { onSelect() }
            .border(
                width = if (photo.isSelected) 3.dp else 0.dp,
                color = if (photo.isSelected) Color(0xFFE0E0E0) else Color.Transparent, // –ü–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤—ã–π —Ü–≤–µ—Ç
                shape = RoundedCornerShape(16.dp)
            )
            .background(Color(0xFF6200EE).copy(alpha = 0.1f))
    ) {
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        photo.byteArray?.let { byteArray ->
            val imageBitmap = remember(byteArray) {
                try {
                    byteArray.toImageBitmap()
                } catch (e: Exception) {
                    null
                }
            }
            
            if (imageBitmap != null) {
                androidx.compose.foundation.Image(
                    bitmap = imageBitmap,
                    contentDescription = "–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è",
                    modifier = Modifier.fillMaxSize(),
                    contentScale = ContentScale.Crop
                )
            } else {
                PhotoPlaceholder(photo.isFromCamera)
            }
        } ?: run {
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
            PhotoPlaceholder(photo.isFromCamera)
        }
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±–æ—Ä–∞
        if (photo.isSelected) {
            Box(
                modifier = Modifier
                    .align(Alignment.TopStart)
                    .padding(8.dp)
                    .size(24.dp)
                    .clip(RoundedCornerShape(12.dp))
                    .background(Color(0xFFF5F5F5)), // –°–≤–µ—Ç–ª–æ-–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤—ã–π —Ñ–æ–Ω
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "‚úì",
                    color = Color(0xFF6200EE), // –û—Å—Ç–∞–≤–ª—è–µ–º —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold
                )
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        Card(
            modifier = Modifier
                .align(Alignment.TopEnd)
                .padding(8.dp)
                .size(24.dp)
                .clickable { onRemove() },
            colors = CardDefaults.cardColors(
                containerColor = Color.Red.copy(alpha = 0.8f)
            ),
            shape = RoundedCornerShape(12.dp)
        ) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "√ó",
                    color = Color.White,
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold
                )
            }
        }
    }
}

@Composable
private fun PhotoPlaceholder(isFromCamera: Boolean) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Text(
            text = if (isFromCamera) "üì∑" else "üñºÔ∏è",
            fontSize = 48.sp
        )
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = if (isFromCamera) "–ö–∞–º–µ—Ä–∞" else "–ì–∞–ª–µ—Ä–µ—è",
            style = MaterialTheme.typography.bodySmall,
            color = Color.Gray,
            textAlign = TextAlign.Center
        )
    }
}

@Composable
fun AddPhotoItem(
    onClick: () -> Unit
) {
    Box(
        modifier = Modifier
            .aspectRatio(1f)
            .clickable { onClick() }
            .border(
                width = 2.dp,
                color = Color.Gray.copy(alpha = 0.3f),
                shape = RoundedCornerShape(16.dp)
            ),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = "üë§+",
                fontSize = 32.sp,
                color = Color.Gray
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ",
                style = MaterialTheme.typography.bodySmall,
                color = Color.Gray,
                textAlign = TextAlign.Center
            )
        }
    }
}
